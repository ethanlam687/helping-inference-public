---
title: "E1 and E2 Data Analysis"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---


# Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(emmeans)
library(ggplot2)
library(dplyr)
library(broom)
library(rstatix)
library(ggpubr)
library(car)
```

# Import data

```{r}
e1 <- read_csv("../data/e1/final_tracker.csv") %>%
  mutate(experiment = "E1")
e2 <- read_csv("../data/e2/final_tracker.csv")%>%
  mutate(experiment = "E2")
e1_first_moves <- read_csv("../data/e1/final_first_moves.csv")
e2_first_moves <- read_csv("../data/e2/first_moves.csv")
combined_saliences <- read_csv("../analysis/salience_first_moves.csv")

```

# Architect move utility comparison between E1 and E2 and across goal types

```{r}

e1_architects <- e1 %>%
  filter(role == "architect")

combined <- bind_rows(e1_architects, e2) %>%
  mutate(
    move_type = case_when(
      move_utility == 1 ~ "Useful",
      move_utility == 0 ~ "Inconsequential",
      move_utility == -1 ~ "Harmful"
    ),
    ID = ifelse(experiment == "E2", anonID, ID)
  )

# counting move_types by proportion
prop_moves <- combined %>%
  count(experiment, ID, goal_type, move_type, name = "move_count") %>%
  group_by(experiment, ID, goal_type) %>%
  complete(move_type = c("Useful", "Harmful", "Inconsequential"), fill = list(move_count = 0)) %>%
  mutate(total_moves = sum(move_count),
         prop = move_count / total_moves) %>%
  ungroup() %>%
  mutate(across(c(experiment, goal_type, move_type, ID), as.factor)) %>%
  select(-move_count, -total_moves)



# check that proportions add to 1
prop_moves %>%
  group_by(experiment, ID, goal_type) %>%
  summarise(total_prop = sum(prop)) %>%
  ungroup()


# quick summary 
prop_moves_summary <- prop_moves %>%
  group_by(goal_type, experiment, move_type) %>%
  summarise(
    mean_prop = mean(prop),
    sd_prop = sd(prop),
    .groups = "drop"
  )

```



### ANOVA

```{r}

prop_model = lm(data = prop_moves, prop ~ experiment*move_type*goal_type)
car::Anova(prop_model)

# Get EMMs from full model, averaged over goal_type
emm <- emmeans(prop_model, ~ experiment | move_type)

# Pairwise comparisons between experiments within each move_type
distr_contrast_results <- contrast(emm, method = "pairwise", adjust = "tukey")

distr_contrast_results
```
### Visualization of move distribution between e1 architects and e2 players 
```{r}
ggplot(prop_moves, aes(x = goal_type, y = prop, fill = experiment)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8), width = 0.7) +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge(width = 0.8), 
               width = 0.2) +
  facet_wrap(~ move_type, scales = "free_y") +
  labs(y = "Mean Proportion of Moves", x = "Goal Type") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()
```

# Helper's move utility following architect's first move rank (pragmatism)

```{r}

# read & join architect ranks + helper first-move data
e1_first_moves %>%
  select(ID, goal, first_move_rank)

helpers <- e1 %>%
  filter(role == "helper", move_id == 1) %>%
  select(ID, goal, helper_move = move, helper_utility = move_utility)

helper_arch_comb <- e1_first_moves %>%
  inner_join(helpers, by = c("ID","goal"))

# make 4-level helper_class
helper_arch_comb <- helper_arch_comb %>%
  mutate(
    helper_class = case_when(
      helper_move == "pass"         ~ "Pass",
      helper_utility ==  1          ~ "Useful move",
      helper_utility ==  0          ~ "Inconsequential move",
      helper_utility == -1          ~ "Harmful move"
    ) %>%
    factor(levels = c("Pass","Useful move","Inconsequential move","Harmful move"))
  )

# frequencies & proportions of each class
helper_arch_comb %>%
  count(helper_class) %>%
  mutate(prop = n / sum(n))

# summary of architect first_move_rank by helper_class
helper_arch_comb_summary <- helper_arch_comb %>%
  group_by(helper_class) %>%
  summarise(
    mean_rank = mean(first_move_rank, na.rm = TRUE),
    sd_rank   = sd(first_move_rank,   na.rm = TRUE),
    n         = n(),
    .groups   = "drop"
  )

```


# One-way ANOVA on first move rank by 4 helper class levels

```{r}
aov_model <- lm(first_move_rank ~ helper_class, data = helper_arch_comb)
car::Anova(aov_model)  

# estimated marginal means & Tukeyâ€adjusted pairwise contrasts
emm <- emmeans(aov_model, ~ helper_class)
helper_arch_contrast_res <- contrast(emm, method = "pairwise", adjust = "tukey")

helper_arch_contrast_res

```

# Visualizaion of helper move utility following architect first move rank

```{r}

ggplot(helper_arch_comb, aes(x = helper_class, y = first_move_rank, fill = helper_class)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.8), width = .7) +
  stat_summary(fun.data = mean_se, geom = "errorbar", position = position_dodge(.8), width = .2) +
  labs(
    x = "Helper Move Classification",
    y = "Mean Architect First-Move Rank"
  ) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  theme_minimal()


```


# Pragmatism Analyses
```{r}

combined_first_moves <- bind_rows(
  e1_first_moves %>% mutate(experiment = "E1"),
  e2_first_moves %>% mutate(experiment = "E2")
) %>%
  mutate(goal_type = word(goal, 1))

anova_model <- lm(first_move_rank ~ experiment * goal_type, data = combined_first_moves)

# ANOVA test 
anova_results <- car::Anova(anova_model)
print(anova_results)

# Compute Estimated Marginal Means (EMMs) and contrasts
emm <- emmeans(anova_model, pairwise ~ experiment | goal_type, adjust = "tukey")
emm_results <- emm$contrasts
print(emm_results)



```

## Visualization of First Move Rank across Goal Types and Experiments

```{r}
ggplot(combined_first_moves,
       aes(x = experiment, y = first_move_rank, fill = experiment)) +
  stat_summary(fun = mean, geom = "bar",
               position = position_dodge(.8), width = .7) +
  stat_summary(fun.data = mean_se, geom = "errorbar",
               position = position_dodge(.8), width = .2) +
  facet_wrap(~ goal_type) +
  labs(
    title = "First Move Rank: E1 vs E2 by Goal Type",
    x = "Experiment",
    y = "Mean First Move Rank"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()


```

# Salience Analyses


## Observed Stepwise and Euclidean Salience E1 vs E2

```{r}

# stepwise
step_model <- lm(stepwise_salience ~ experiment * goal_type, data = combined_saliences)
car::Anova(step_model) 

# Get EMMs for experiment within each goal_type
emm_goal <- emmeans(step_model, ~ experiment | goal_type)

# Pairwise comparisons between experiments within goal_type
step_contrast_results <- contrast(emm_goal, method = "pairwise", adjust = "tukey")
print(step_contrast_results)

# euclidean
eucl_model <- lm(euclidean_salience ~ experiment * goal_type, data = combined_saliences)
car::Anova(eucl_model)

emm_eucl_goal <- emmeans(eucl_model, ~ experiment | goal_type)
  
eucl_contrast_results <- contrast(emm_eucl_goal, method = "pairwise", adjust = "tukey")
print(eucl_contrast_results)

```

## Observed vs. Random baseline salience 
``` {r}

# observed-baseline differences
combined_saliences <- combined_saliences %>%
  mutate(
    diff_stepwise = stepwise_salience - random_stepwise_salience,
    diff_euclidean = euclidean_salience - random_euclidean_salience
  )
# stepwise gap
step_gap_model <- lm(diff_stepwise ~ experiment * goal_type,
                     data = combined_saliences)
car::Anova(step_gap_model)

# get EMMs for experiment within each goal_type
emm_step_gap <- emmeans(step_gap_model, ~ experiment | goal_type)

# pairwise comparisons between experiments within goal_type
step_gap_contrast_results <- contrast(emm_step_gap,
                                      method = "pairwise",
                                      adjust = "tukey")
print(step_gap_contrast_results)

# euclidean gap
eucl_gap_model <- lm(diff_euclidean ~ experiment * goal_type,
                     data = combined_saliences)
car::Anova(eucl_gap_model)

emm_eucl_gap <- emmeans(eucl_gap_model, ~ experiment | goal_type)

eucl_gap_contrast_results <- contrast(emm_eucl_gap,
                                      method = "pairwise",
                                      adjust = "tukey")
print(eucl_gap_contrast_results)


```
## Salience data manipulation

```{r long_sal, include=FALSE}

long_sal <- combined_saliences %>%
  pivot_longer(
    cols     = c(stepwise_salience, euclidean_salience),
    names_to = "salience_type",
    values_to= "salience"
  )

long_sal <- combined_saliences %>%
  pivot_longer(
    cols         = c(stepwise_salience,
                     euclidean_salience,
                     random_stepwise_salience,
                     random_euclidean_salience),
    names_to     = c("salience_source","salience_type"),
    names_pattern= "(random_)?(stepwise|euclidean)_salience",
    values_to    = "salience"
  ) %>%
  mutate(
    salience_source = if_else(salience_source == "random_", 
                              "baseline", 
                              "observed"),
    salience_type   = paste0(salience_type, "_salience")
  )

```

## Salience Visualization

```{r}

# observed salience by goal type e1 vs e2
ggplot(long_sal,
       aes(x = experiment, y = salience, fill = experiment)) +
  stat_summary(fun     = mean,
               geom    = "bar",
               position= position_dodge(.8),
               width   = .7) +
  stat_summary(fun.data = mean_se,
               geom     = "errorbar",
               position = position_dodge(.8),
               width    = .2) +
  facet_grid(salience_type ~ goal_type,
             scales   = "free_y",
             labeller = labeller(
               salience_type = c(
                 stepwise_salience  = "Stepwise",
                 euclidean_salience = "Euclidean"
               )
             )
  ) +
  labs(x     = "Experiment",
       y     = "Mean Salience",
       title = "Stepwise vs Euclidean Salience by Goal Type") +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  theme_minimal()



# observed vs baseline, facetted by salience type and goal
ggplot(long_sal,
       aes(x = experiment, y = salience, fill = salience_source)) +
  stat_summary(fun       = mean,
               geom      = "bar",
               position  = position_dodge(.8),
               width     = .7) +
  stat_summary(fun.data = mean_se,
               geom     = "errorbar",
               position = position_dodge(.8),
               width    = .2) +
  facet_grid(salience_type ~ goal_type,
             scales   = "free_y",
             labeller = labeller(
               salience_type = c(
                 stepwise_salience  = "Stepwise",
                 euclidean_salience = "Euclidean"
               )
             )
  ) +
  labs(x     = "Experiment",
       y     = "Mean Salience",
       fill  = "Source",
       title = "Observed vs Baseline Salience by Goal Type") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

```





