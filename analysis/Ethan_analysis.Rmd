---
title: "E1 and E2 Data Analysis"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---


# Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(emmeans)
library(ggplot2)
library(dplyr)
library(broom)
library(rstatix)
library(ggpubr)
library(car)
library(stringr)
``` 

# Import data

```{r}
e1 <- read_csv("../data/e1/final_tracker.csv") %>%
  mutate(experiment = "E1")
e2 <- read_csv("../data/e2/final_tracker.csv")%>%
  mutate(experiment = "E2")
e1_first_moves <- read_csv("../data/e1/final_first_moves.csv")
e2_first_moves <- read_csv("../data/e2/first_moves.csv")
combined_saliences <- read_csv("../analysis/salience_first_moves.csv")
e1_model_results <- read_csv("../data/e1/all_model_results.csv") 


```

# Architect move utility comparison between E1 and E2 and across goal types

```{r}

e1_architects <- e1 %>%
  filter(role == "architect")

combined <- bind_rows(e1_architects, e2) %>%
  mutate(
    move_type = case_when(
      move_utility == 1 ~ "Useful",
      move_utility == 0 ~ "Inconsequential",
      move_utility == -1 ~ "Harmful"
    ),
    ID = ifelse(experiment == "E2", anonID, ID)
  )

# counting move_types by proportion
prop_moves <- combined %>%
  count(experiment, ID, goal_type, move_type, name = "move_count") %>%
  group_by(experiment, ID, goal_type) %>%
  complete(move_type = c("Useful", "Harmful", "Inconsequential"), fill = list(move_count = 0)) %>%
  mutate(total_moves = sum(move_count),
         prop = move_count / total_moves) %>%
  ungroup() %>%
  mutate(across(c(experiment, goal_type, move_type, ID), as.factor)) %>%
  select(-move_count, -total_moves)



# check that proportions add to 1
prop_moves %>%
  group_by(experiment, ID, goal_type) %>%
  summarise(total_prop = sum(prop)) %>%
  ungroup()


# quick summary 
prop_moves_summary <- prop_moves %>%
  group_by(goal_type, experiment, move_type) %>%
  summarise(
    mean_prop = mean(prop),
    sd_prop = sd(prop),
    .groups = "drop"
  )

```



### ANOVA

```{r}

prop_model = lm(data = prop_moves, prop ~ experiment*move_type*goal_type)
car::Anova(prop_model)

# Get EMMs from full model, averaged over goal_type
emm <- emmeans(prop_model, ~ experiment | move_type)

# Pairwise comparisons between experiments within each move_type
distr_contrast_results <- contrast(emm, method = "pairwise", adjust = "tukey")

distr_contrast_results
```
### Visualization of move distribution between e1 architects and e2 players 
```{r}
ggplot(prop_moves, aes(x = goal_type, y = prop, fill = experiment)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8), width = 0.7) +
  stat_summary(fun.data = mean_se, geom = "errorbar", 
               position = position_dodge(width = 0.8), 
               width = 0.2) +
  facet_wrap(~ move_type, scales = "free_y") +
  labs(y = "Mean Proportion of Moves", x = "Goal Type") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()
```

# Helper's move utility following architect's first move rank (pragmatism)

```{r}

# read & join architect ranks + helper first-move data
e1_first_moves %>%
  select(ID, goal, first_move_rank)

helpers <- e1 %>%
  filter(role == "helper", move_id == 1) %>%
  select(ID, goal, helper_move = move, helper_utility = move_utility)

helper_arch_comb <- e1_first_moves %>%
  inner_join(helpers, by = c("ID","goal"))

# make 4-level helper_class
helper_arch_comb <- helper_arch_comb %>%
  mutate(
    helper_class = case_when(
      helper_move == "pass"         ~ "Pass",
      helper_utility ==  1          ~ "Useful move",
      helper_utility ==  0          ~ "Inconsequential move",
      helper_utility == -1          ~ "Harmful move"
    ) %>%
    factor(levels = c("Pass","Useful move","Inconsequential move","Harmful move"))
  )

# frequencies & proportions of each class
helper_arch_comb %>%
  count(helper_class) %>%
  mutate(prop = n / sum(n))

# summary of architect first_move_rank by helper_class
helper_arch_comb_summary <- helper_arch_comb %>%
  group_by(helper_class) %>%
  summarise(
    mean_rank = mean(first_move_rank, na.rm = TRUE),
    sd_rank   = sd(first_move_rank,   na.rm = TRUE),
    n         = n(),
    .groups   = "drop"
  )

```


# One-way ANOVA on first move rank by 4 helper class levels

```{r}
aov_model <- lm(first_move_rank ~ helper_class, data = helper_arch_comb)
car::Anova(aov_model)  

# estimated marginal means & Tukeyâ€adjusted pairwise contrasts
emm <- emmeans(aov_model, ~ helper_class)
helper_arch_contrast_res <- contrast(emm, method = "pairwise", adjust = "tukey")

helper_arch_contrast_res

```

# Visualizaion of helper move utility following architect first move rank

```{r}

ggplot(helper_arch_comb, aes(x = helper_class, y = first_move_rank, fill = helper_class)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.8), width = .7) +
  stat_summary(fun.data = mean_se, geom = "errorbar", position = position_dodge(.8), width = .2) +
  labs(
    x = "Helper Move Classification",
    y = "Mean Architect First-Move Rank"
  ) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  theme_minimal()


```


# Pragmatism Analyses
```{r}

combined_first_moves <- bind_rows(
  e1_first_moves %>% mutate(experiment = "E1"),
  e2_first_moves %>% mutate(experiment = "E2")
) %>%
  mutate(goal_type = word(goal, 1))

anova_model <- lm(first_move_rank ~ experiment * goal_type, data = combined_first_moves)

# ANOVA test 
anova_results <- car::Anova(anova_model)
print(anova_results)

# Compute Estimated Marginal Means (EMMs) and contrasts
emm <- emmeans(anova_model, pairwise ~ experiment | goal_type, adjust = "tukey")
emm_results <- emm$contrasts
print(emm_results)



```

## Visualization of First Move Rank across Goal Types and Experiments

```{r}
ggplot(combined_first_moves,
       aes(x = experiment, y = first_move_rank, fill = experiment)) +
  stat_summary(fun = mean, geom = "bar",
               position = position_dodge(.8), width = .7) +
  stat_summary(fun.data = mean_se, geom = "errorbar",
               position = position_dodge(.8), width = .2) +
  facet_wrap(~ goal_type) +
  labs(
    title = "First Move Rank: E1 vs E2 by Goal Type",
    x = "Experiment",
    y = "Mean First Move Rank"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()


```

## Paired E1-E2 Pragmatism Analysis

```{r}
e1_prag <- combined_first_moves %>%
  filter(experiment == "E1") %>%
  select(ID, goal, goal_type, first_move_rank_e1 = first_move_rank)
e2_prag <- combined_first_moves %>%
  filter(experiment == "E2") %>%
  select(importId, anonID, goal, goal_type, first_move_rank_e2 = first_move_rank)

paired_prag <- e2_prag %>%
  inner_join(e1_prag, by = c("importId" = "ID", "goal", "goal_type"))
view(paired_prag)

```
## E1-E2 Unpaired t-test for Pragmatism

```{r}

goal_types <- unique(paired_prag$goal_type)
for(gt in goal_types) {
  temp <- paired_prag %>% filter(goal_type == gt)
  cat("====", gt, "====\n")
  print(t.test(temp$first_move_rank_e1, temp$first_move_rank_e2, var.equal = TRUE))
  cat("\n")}

```
## Visualization of Paired Pragmatism Analysis

```{r}

ggplot(
  bind_rows(
    paired_prag %>%
      transmute(
        experiment = "E1",
        first_move_rank = first_move_rank_e1,
        goal_type = goal_type
      ),
    paired_prag %>%
      transmute(
        experiment = "E2",
        first_move_rank = first_move_rank_e2,
        goal_type = goal_type
      )
  ),
  aes(x = experiment, y = first_move_rank, fill = experiment)
) +
  stat_summary(fun = mean, geom = "bar",
               position = position_dodge(.8), width = .7) +
  stat_summary(fun.data = mean_se, geom = "errorbar",
               position = position_dodge(.8), width = .2) +
  facet_wrap(~ goal_type) +
  labs(
    title = "First Move Rank: Paired E1 vs E2 by Goal Type",
    x = "Experiment",
    y = "Mean First Move Rank"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

```


# Salience Analyses


## Observed Stepwise and Euclidean Salience E1 vs E2

```{r}

# stepwise
step_model <- lm(stepwise_salience ~ experiment * goal_type, data = combined_saliences)
car::Anova(step_model) 

# Get EMMs for experiment within each goal_type
emm_goal <- emmeans(step_model, ~ experiment | goal_type)

# Pairwise comparisons between experiments within goal_type
step_contrast_results <- contrast(emm_goal, method = "pairwise", adjust = "tukey")
print(step_contrast_results)

# euclidean
eucl_model <- lm(euclidean_salience ~ experiment * goal_type, data = combined_saliences)
car::Anova(eucl_model)

emm_eucl_goal <- emmeans(eucl_model, ~ experiment | goal_type)
  
eucl_contrast_results <- contrast(emm_eucl_goal, method = "pairwise", adjust = "tukey")
print(eucl_contrast_results)

```

## Paired E1-E2 Observed Saliences

```{r}

e1_saliences <- combined_saliences %>%
  filter(experiment == "E1") %>%
  select(ID, goal, goal_type, stepwise_salience_e1 = stepwise_salience, euclidean_salience_e1 = euclidean_salience)
e2_saliences <- combined_saliences %>%
  filter(experiment =="E2") %>%
  select(importId, anonID, goal, goal_type, stepwise_salience_e2 = stepwise_salience, euclidean_salience_e2 = euclidean_salience)

paired_salience <- e2_saliences %>%
  inner_join(e1_saliences, by = c("importId" = "ID", "goal", "goal_type"))

```

## E1-E2 unpaired t-test for observed saliences

```{r}

# stepwise salience
goal_types <- unique(paired_salience$goal_type)
for(gt in goal_types) {
  temp <- paired_salience %>% filter(goal_type == gt)
  cat("====", gt, "====\n")
  print(t.test(temp$stepwise_salience_e1, temp$stepwise_salience_e2, var.equal = TRUE))
  cat("\n")}

# euclidean salience
for(gt in goal_types) {
  temp <- paired_salience %>% filter(goal_type == gt)
  cat("====", gt, "====\n")
  print(t.test(temp$euclidean_salience_e1, temp$euclidean_salience_e2, var.equal = TRUE))
  cat("\n")}


```

## Visualization of Observed Salience Paired E1-E2

```{r}
# stepwise
ggplot(
  bind_rows(
    paired_salience %>%
      transmute(
        experiment = "E1",
        salience = stepwise_salience_e1,
        goal_type = goal_type
      ),
    paired_salience %>%
      transmute(
        experiment = "E2",
        salience = stepwise_salience_e2,
        goal_type = goal_type
      )
  ),
  aes(x = experiment, y = salience, fill = experiment)
) +
  stat_summary(fun = mean, geom = "bar",
               position = position_dodge(.8), width = .7) +
  stat_summary(fun.data = mean_se, geom = "errorbar",
               position = position_dodge(.8), width = .2) +
  facet_wrap(~ goal_type) +
  labs(
    title = "Stepwise Salience: Paired E1 vs E2 by Goal Type",
    x = "Experiment",
    y = "Mean Stepwise Salience"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

# euclidean
ggplot(
  bind_rows(
    paired_salience %>%
      transmute(
        experiment = "E1",
        salience = euclidean_salience_e1,
        goal_type = goal_type
      ),
    paired_salience %>%
      transmute(
        experiment = "E2",
        salience = euclidean_salience_e2,
        goal_type = goal_type
      )
  ),
  aes(x = experiment, y = salience, fill = experiment)
) +
  stat_summary(fun = mean, geom = "bar",
               position = position_dodge(.8), width = .7) +
  stat_summary(fun.data = mean_se, geom = "errorbar",
               position = position_dodge(.8), width = .2) +
  facet_wrap(~ goal_type) +
  labs(
    title = "Euclidean Salience: Paired E1 vs. E2 by Goal Type",
    x = "Experiment",
    y = "Mean Euclidean Salience"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()


```

## Observed vs. Random baseline salience 
``` {r}

# observed-baseline differences
combined_saliences <- combined_saliences %>%
  mutate(
    stepwise_salience = as.numeric(stepwise_salience),
    euclidean_salience = as.numeric(euclidean_salience),
    random_stepwise_salience = as.numeric(random_stepwise_salience),
    random_euclidean_salience = as.numeric(random_euclidean_salience)
  ) %>%
  mutate(
    diff_stepwise = stepwise_salience - random_stepwise_salience,
    diff_euclidean = euclidean_salience - random_euclidean_salience
  )
# stepwise gap
step_gap_model <- lm(diff_stepwise ~ experiment * goal_type,
                     data = combined_saliences)
car::Anova(step_gap_model)

# get EMMs for experiment within each goal_type
emm_step_gap <- emmeans(step_gap_model, ~ experiment | goal_type)

# pairwise comparisons between experiments within goal_type
step_gap_contrast_results <- contrast(emm_step_gap,
                                      method = "pairwise",
                                      adjust = "tukey")
print(step_gap_contrast_results)

# euclidean gap
eucl_gap_model <- lm(diff_euclidean ~ experiment * goal_type,
                     data = combined_saliences)
car::Anova(eucl_gap_model)

emm_eucl_gap <- emmeans(eucl_gap_model, ~ experiment | goal_type)

eucl_gap_contrast_results <- contrast(emm_eucl_gap,
                                      method = "pairwise",
                                      adjust = "tukey")
print(eucl_gap_contrast_results)


```
## Salience data manipulation

```{r long_sal, include=FALSE}

long_sal <- combined_saliences %>%
  pivot_longer(
    cols     = c(stepwise_salience, euclidean_salience),
    names_to = "salience_type",
    values_to= "salience"
  )

long_sal <- combined_saliences %>%
  pivot_longer(
    cols         = c(stepwise_salience,
                     euclidean_salience,
                     random_stepwise_salience,
                     random_euclidean_salience),
    names_to     = c("salience_source","salience_type"),
    names_pattern= "(random_)?(stepwise|euclidean)_salience",
    values_to    = "salience"
  ) %>%
  mutate(
    salience_source = if_else(salience_source == "random_", 
                              "baseline", 
                              "observed"),
    salience_type   = paste0(salience_type, "_salience")
  )

```

## Salience Visualization

```{r}

# observed salience by goal type e1 vs e2
ggplot(long_sal,
       aes(x = experiment, y = salience, fill = experiment)) +
  stat_summary(fun     = mean,
               geom    = "bar",
               position= position_dodge(.8),
               width   = .7) +
  stat_summary(fun.data = mean_se,
               geom     = "errorbar",
               position = position_dodge(.8),
               width    = .2) +
  facet_grid(salience_type ~ goal_type,
             scales   = "free_y",
             labeller = labeller(
               salience_type = c(
                 stepwise_salience  = "Stepwise",
                 euclidean_salience = "Euclidean"
               )
             )
  ) +
  labs(x     = "Experiment",
       y     = "Mean Salience",
       title = "Stepwise vs Euclidean Salience by Goal Type") +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  theme_minimal()



# observed vs baseline, facetted by salience type and goal
ggplot(long_sal,
       aes(x = experiment, y = salience, fill = salience_source)) +
  stat_summary(fun       = mean,
               geom      = "bar",
               position  = position_dodge(.8),
               width     = .7) +
  stat_summary(fun.data = mean_se,
               geom     = "errorbar",
               position = position_dodge(.8),
               width    = .2) +
  facet_grid(salience_type ~ goal_type,
             scales   = "free_y",
             labeller = labeller(
               salience_type = c(
                 stepwise_salience  = "Stepwise",
                 euclidean_salience = "Euclidean"
               )
             )
  ) +
  labs(x     = "Experiment",
       y     = "Mean Salience",
       fill  = "Source",
       title = "Observed vs Baseline Salience by Goal Type") +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal()

```



# Move "Correction" Analysis

```{r}

e1_move_list <- e1 %>%
  mutate(arch_move_from = as.numeric(str_extract(move, "(?<=\\().+?(?=,)")),
         helper_move_to = as.numeric(str_extract(move, "(?<=, ).+?(?=\\))"))) 

e1_move_list <- e1_move_list %>%
  arrange(ID, goal, move_id) %>%
  group_by(ID, goal) %>%
  mutate(
    next_move_role = lead(role),
    arch_pickup = lead(arch_move_from),
    arch_move_utility = lead(move_utility),
    is_correction = (role == "helper") & (next_move_role == "architect") & (helper_move_to == arch_pickup)
  ) %>%
  ungroup()

corrections <- e1_move_list %>%
  filter(is_correction)


# corrections per game
corrections_per_game <- corrections %>%
  group_by(ID, goal, goal_type) %>%
  summarise(num_corrections = n(), .groups = "drop")

# average corrections per game by move_type and goal_type
corrections_per_game_by_type <- corrections %>%
  group_by(ID, goal, goal_type, helper_move_utility = move_utility) %>%
  summarise(num_corrections = n(), .groups = "drop") %>%
  group_by(goal_type, helper_move_utility) %>%
  summarise(avg_corrections_per_game = mean(num_corrections), n_games = n(), .groups = "drop")

print(corrections_per_game_by_type)

correction_prop <- corrections %>% 
  count(goal_type, helper_move_utility = move_utility) %>%
  group_by(goal_type) %>%
  mutate(total_corrections = sum(n), proportion = n / total_corrections) %>%
  ungroup()
print(correction_prop)



```

### Visualization of Corrections by Goal Type

```{r}
# visualization by propotion
ggplot(correction_prop, aes(x = goal_type, y = proportion, fill = as.factor(helper_move_utility))) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = scales::percent(proportion, accuracy = 1)),
              position = position_stack(vjust = 0.5), size = 3) +
    labs(
      title = "Correction Proportion by Move Utility and Goal Type", x = "Goal Type", y = "Correction Prop", fill = "Helper Move Utility") +
    scale_fill_brewer(palette = "Set2") +
    theme_minimal()

# count of corrections by goal type
ggplot(corrections_per_game_by_type, 
       aes(x = as.factor(helper_move_utility), 
           y = avg_corrections_per_game, 
           fill = as.factor(helper_move_utility))) +
  geom_bar(stat = "identity", position = position_dodge(.8), width = .7) +
  facet_wrap(~ goal_type) +
  labs(title = "Average Corrections per Game by Move Type and Goal Type", x = "Helper Move Utility", y = "Avg. Corrections per Game") +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  theme_minimal()


```

# Compiled Optimizer Results

```{r}


# lowest NLL per goal_type and ID
lowest_model_per_group <- e1_model_results %>%
  group_by(ID, goal_type) %>%
  slice_min(order_by = NLL, n = 1, with_ties = FALSE) %>%
  ungroup()

# count how many times each model was best, grouped by goal type
model_wins_by_goal <- lowest_model_per_group %>%
  count(goal_type, model, sort = TRUE)


ggplot(model_wins_by_goal, aes(x = model, y = n, fill = model)) +
  geom_col() +
  facet_wrap(~ goal_type) +
  labs(
    title = "Model Wins (Lowest NLL per ID) by Goal Type",
    x = "Model",
    y = "# of Wins"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# mean NLL by model and goal type
summary_nll <- e1_model_results %>%
  group_by(goal_type, model) %>%
  summarise(
    mean_nll = mean(NLL, na.rm = TRUE),
    se_nll = sd(NLL, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

ggplot(summary_nll, aes(x = model, y = mean_nll, fill = model)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(0.8), width = 0.7) + 
  geom_errorbar(aes(ymin = mean_nll - se_nll, ymax = mean_nll + se_nll),
                position = position_dodge(0.8), width = 0.2) +
  facet_wrap(~ goal_type) +
  labs(
    title = "Mean NLL by Model and Goal Type",
    x = "Model",
    y = "Mean Negative Log-Likelihood (NLL)"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()


```



