---
title: "E1 and E2 Data Analysis"
output: html_notebook
---

# Comparison of the move distributions between E1 and E2 and across Goal Types

```{r}
library(tidyverse)

e1 <- read_csv("data/e1/final_tracker.csv")
e2 <- read_csv("data/e2/final_tracker.csv")

e1_architects <- e1 %>%
  filter(role == "architect") %>%
  mutate(experiment = "E1")

e2 <- e2 %>%
  mutate(experiment = "E2")

combined <- bind_rows(e1_architects, e2)

combined <- combined %>%
  mutate(
    move_utility = case_when(
      move_utility == 1 ~ "useful",
      move_utility == 0 ~ "inconsequential",
      move_utility == -1 ~ "harmful"
    ),
    move_type = case_when(
      move_utility == "useful" ~ "Useful",
      move_utility == "inconsequential" ~ "Inconsequential",
      move_utility == "harmful" ~ "Harmful"
    )
  )

# total number of different move types
move_summary <- combined %>%
  group_by(experiment, move_utility, goal_type) %>%
  summarise(count = n(), .groups = 'drop') %>%
  pivot_wider(names_from = move_utility, values_from = count, values_fill = 0) %>%
  rename(
    harmful = `harmful`,
    inconsequential = `inconsequential`,
    useful = `useful`
  ) %>%
  mutate(total_moves = harmful + inconsequential + useful)

# average distribution of moves per participant, grouped by goal type and experiment
avg_moves_by_goal <- combined %>%
  group_by(experiment, ID, anonID, goal_type, move_type) %>%
  summarise(count = n(), .groups = 'drop') %>%
  pivot_wider(names_from = move_type, values_from = count, values_fill = 0) %>%
  mutate(total_moves = Useful + Inconsequential + Harmful)



# summary statistics: mean and SD of move types across goal types and experiments
avg_moves_summary <- avg_moves_by_goal %>%
  group_by(goal_type, experiment) %>%
  summarise(
    mean_Useful = mean(Useful),
    sd_Useful = sd(Useful),
    mean_Inconsequential = mean(Inconsequential),
    sd_Inconsequential = sd(Inconsequential),
    mean_Harmful = mean(Harmful),
    sd_Harmful = sd(Harmful),
    mean_total_moves = mean(total_moves),
    sd_total_moves = sd(total_moves)
  )
head(avg_moves_summary)

```

##### Visualization of move distributions

```{r}
# useful moves visualization
ggplot(avg_moves_summary, aes(x = goal_type, y = mean_Useful, fill = experiment)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) + 
  geom_errorbar(aes(ymin = mean_Useful - sd_Useful, ymax = mean_Useful + sd_Useful),
  position = position_dodge(width = 0.9),
  width = 0.2) +
  labs(title = "Players' Avg Number of Useful Moves Per Goal Type by Experiment",
       x = "Goal Type", y = "Average Useful Moves Per Player", fill = "Experiment" ) +
  theme_minimal()

ggplot(avg_moves_summary, aes(x = goal_type, y = mean_Harmful, fill = experiment)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_Harmful - sd_Harmful, ymax = mean_Harmful + sd_Harmful),
  position = position_dodge(width = 0.9),
  width = 0.2) +
  labs(title = "Players' Avg Number of Harmful Moves Per Goal Type by Experiment",
       x = "Goal Type", y = "Average Harmful Moves Per Player", fill = "Experiment") +
  theme_minimal()

ggplot(avg_moves_summary, aes(x = goal_type, y = mean_Inconsequential, fill = experiment)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_Inconsequential - sd_Inconsequential, ymax = mean_Inconsequential + sd_Inconsequential),
  position = position_dodge(width = 0.9),
  width = 0.2) +
  labs(title = "Players' Avg Number of Inconsequential Moves Per Goal Type by Experiment",
       x = "Goal Type", y = "Average Inconsequential Moves Per Player", fill = "Experiment") +
  theme_minimal()
```

##### Statistical Tests Comparing Move Types Across Experiments

E2 players made significantly more useful moves than E1 players across all goal-types. 

For the "move" goal type, E2 players also made significantly more inconsequential moves than E1 players. 

```{r}

library(dplyr)
library(tidyr)
library(purrr)
library(broom)

ttest_all <- long_tbl %>%
  # group and nested data by goal_type & move_type
  
  group_by(goal_type, move_type) %>%
  nest() %>%

  # run t-test on each nested chunk
  mutate(
    ttest_obj = map(data, ~ t.test(count ~ experiment, data = .x, var.equal = TRUE)),
    tidied    = map(ttest_obj, tidy)
  ) %>%
  
  unnest(tidied) %>%
  
  transmute(
    goal_type,
    move_type,
    mean_E1 = estimate1,
    mean_E2 = estimate2,
    t_value = statistic,
    p.value,
    signficant = p.value < 0.05
  )

print(ttest_all)


```


# Follow-up measure of pragmatism seen through Helper's move utility following rank of Architect's first move (pragmatism rank). 

Found no significant correlation between architect first move rank and helper utility. 

```{r}
library(tidyverse)

# select architects' firstâ€move rank
arch <- read_csv("data/e1/final_first_moves.csv") %>%
  rename(id = ID) %>%
  select(id,goal, first_move_rank)

# select helper's first move utility
helpers <- read_csv("data/e1/final_tracker.csv") %>%
  rename(id = ID) %>%
  filter(role == "helper", move_id == 1) %>%
  select(id, goal, helper_move = move, helper_utility = move_utility) %>%
  mutate(
    helper_action = if_else(helper_move == "pass", "pass", "move")
  )

# join architect ranks to helper utilities
df_comb <- arch %>%
  inner_join(helpers, by = c("id","goal"))

# how often will helpers pass or move on their first move? 
df_comb %>%
  count(helper_action) %>%
  mutate(prop = n / sum(n))

# do more pragmatic arch moves reduce the chance of a pass?

# create a arch_rank column based on the median of first_move_rank, splitting into high and low rank
df_comb <- df_comb %>%
  mutate(arch_rank = if_else(first_move_rank <= median(first_move_rank, na.rm = TRUE), "high_prag", "low_prag"))

helper_pass_summary <- df_comb %>%
# count how many helper_actions occurred in each arch_rank
  count(arch_rank, helper_action) %>%
  group_by(arch_rank) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()


print(helper_pass_summary)



# Spearman correlation between first_move_rank and helper_utility

library(broom)
library(dplyr)

tidy(cor_result <- cor.test(df_comb$first_move_rank,
                    df_comb$helper_utility,
                    method = "spearman")) %>%
  transmute(
    rho = round(estimate, 2),
    p_value = round(p.value, 3),
  )



# visualize data with scatterplot
ggplot(df_comb, aes(x = first_move_rank, y = helper_utility)) +
  geom_jitter(width = 0.2, height = 0.05, alpha = 0.6) +
  geom_smooth(method = "loess", se = TRUE, color = "steelblue") +
  labs(
    title = "Helper Utility vs. Architect First Move Rank",
    x = "Architect First Move Rank (lower = more pragmatic)",
    y = "Helper Move Utility"
  ) +
  theme_minimal()

# boxplot for group comparision
df_comb <- df_comb %>%
  mutate(
    arch_rank = factor(
      arch_rank,
      levels = c("high_prag", "low_prag"),
      labels = c("High Pragmatism", "Low Pragmatism")
  )
)
ggplot(df_comb, aes(x = arch_rank, y = helper_utility, fill = arch_rank)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, height = 0.05, alpha = 0.5, color = "black", size = 0.8) +
  scale_fill_brewer(palette = "Set2", guide = "none") +
  labs(
    title = "Helper Utility by Architect Pragmatism",
    x = "Architect Pragmatism",
    y = "Helper Move Utility"
  ) +
  theme_minimal()

```

# Extended to all moves

```{r}


```






